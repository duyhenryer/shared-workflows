name: Check CI Status

on:
  workflow_call:
    inputs:
      runs-on:
        default: ubuntu-latest
        required: false
        type: string
      slack_msg:
        description: |
          Message to be posted to the slack for build result.
        type: string
        default: "Build <${{ github.event.repository.html_url}}/actions/runs/${{ github.run_id }}|#${{ github.run_number }}> of <${{ github.event.repository.html_url}}|${{ github.repository }}> by ${{ github.actor }}."
      slack_channel_id:
        description: |
          Name of the slack channel to post the message in.
        type: string
        default: ""
      slack_thread_ts:
        description: |
          Slack thread timestamp for reply (from pr-checks output).
          If provided, replies in that thread. If empty, sends standalone message.
        type: string
        required: false
        default: ""
    secrets:
      SLACK_BOT_TOKEN:
        description: "Slack bot token for notifications"
        required: true

jobs:
  workflow-status:
    runs-on: ${{ inputs.runs-on }}
    if: ${{ always() }}
    outputs:
      status: ${{ steps.fetch-workflow-status.outputs.status }}
    steps:
      - uses: actions/github-script@v8
        id: fetch-workflow-status
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });
            
            const allowedFailedJobs = [
              "unit-tests / unit-tests (stable)",
            ]
            
            // Get failed jobs count, excluding allowed failed jobs
            const failedJobsCount = jobs.data.jobs.filter(job => job.status === "completed" && job.conclusion === "failure" && !allowedFailedJobs.includes(job.name)).length;
            const cancelledJobsCount = jobs.data.jobs.filter(job => job.status === "completed" && job.conclusion === "cancelled").length;
            
            // Get workflow status based on failed and cancelled jobs count
            const workflowStatus = failedJobsCount > 0 ? "failed" : cancelledJobsCount > 0 ? "cancelled" : "success";
            core.setOutput("status", workflowStatus);
            
            // Write summary
            var jobHeader = [[{data: 'Name', header: true}, {data: 'Result', header: true, colspan: 2}]]
            var jobResults = jobs.data.jobs.filter(job => job.status == 'completed' || job.status == 'skipped').map(job => {
              return [
                '<a href="' + job.html_url + '">' + job.name + '</a>',
                job.status == 'completed' ? (job.conclusion == 'success' ? '✅' : job.conclusion == 'cancelled' ? '⚪' : job.conclusion == 'failure' ? (allowedFailedJobs.includes(job.name) ? '⚠️' : '❌') : '⚪'): '⚪',
                job.status == 'completed' ? job.conclusion : job.status,
              ]
            })
            var jobTable = jobHeader.concat(jobResults)
            await core.summary
              .addHeading('Workflow Status')
              .addTable(jobTable)
              .write()
            
            // Set failed if workflow status is failed
            if (workflowStatus == "failed") {
              const failedJobs = jobs.data.jobs.filter(job => job.status === "completed" && job.conclusion === "failure" && !allowedFailedJobs.includes(job.name));
              // Log failure but do not fail the status job itself, so notification can proceed cleanly
              console.log("Workflow failed due to jobs: " + failedJobs.map(job => job.name).join(", "));
            }

  notify:
    runs-on: ${{ inputs.runs-on }}
    if: ${{ always() }}
    needs:
      - workflow-status
    steps:
      - name: Slack channel
        uses: actions/github-script@v8
        id: slack-channel
        with:
          script: |
            const inputs = ${{ toJSON(inputs) }}
            
            var slack_channel_id = inputs.slack_channel_id
            if (slack_channel_id == "") {
              // Default channel ID - replace with your actual Slack channel ID
              slack_channel_id = process.env.SLACK_CHANNEL_ID || ''
            }
            console.log('Slack channel:', slack_channel_id);
            core.setOutput('slack_channel_id', slack_channel_id);
        env:
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}


      - name: Checkout shared-workflows (for composite action)
        uses: actions/checkout@v6
        with:
          repository: duyhenryer/shared-workflows
          path: .shared-workflows
          sparse-checkout: |
            .github/actions/slack-ci-notification

      - name: Slack CI Notification
        if: ${{ steps.slack-channel.outputs.slack_channel_id != '' }}
        uses: ./.shared-workflows/.github/actions/slack-ci-notification
        with:
          channel_id: ${{ steps.slack-channel.outputs.slack_channel_id }}
          status: ${{ needs.workflow-status.outputs.status }}
          thread_ts: ${{ inputs.slack_thread_ts }}
          slack_bot_token: ${{ secrets.SLACK_BOT_TOKEN }}