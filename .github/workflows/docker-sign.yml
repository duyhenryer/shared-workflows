name: Cosign Image Signing

# Reusable workflow: signs Docker images using Cosign (keyless / OIDC).
# Call after docker-build-go.yml (or any build workflow) that exposes tags + digest.

on:
  workflow_call:
    inputs:
      tags:
        description: 'Image tags to sign (newline-separated, from docker/metadata-action)'
        required: true
        type: string
      digest:
        description: 'Image digest (sha256:...)'
        required: true
        type: string
      runs-on:
        description: 'Runner type'
        required: false
        type: string
        default: 'ubuntu-latest'

jobs:
  sign:
    name: Sign Image
    runs-on: ${{ inputs.runs-on }}
    permissions:
      contents: read
      packages: write
      id-token: write  # Required for Cosign keyless (OIDC) signing

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign image with Cosign
        env:
          DIGEST: ${{ inputs.digest }}
          TAGS: ${{ inputs.tags }}
        run: |
          images=""
          for tag in ${TAGS}; do
            images+="${tag}@${DIGEST} "
          done
          cosign sign --yes ${images}
