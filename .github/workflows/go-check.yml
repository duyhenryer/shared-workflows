name: Go Check

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_call:
    inputs:
      runs-on:
        default: ubuntu-latest
        required: false
        type: string
      command-test:
        required: true
        type: string
      setup-go:
        required: false
        type: boolean
        default: true
        description: Indicate whether should install go or not. Default is true
      gomod-path:
        required: false
        type: string
        default: "go.mod"
        description: Indicate the path of go.mod file. Default is go.mod
      lint:
        required: false
        type: boolean
        default: false
        description: Indicate whether should run golint or not. Default is false
      lint-path:
        required: false
        type: string
        default: ".golangci.yml"
        description: Indicate the path of lint config file. Default is .golangci.yml
      lint-timeout:
        required: false
        type: string
        default: 10m
        description: Indicate the timeout of golangci-lint. Default is 10 minutes
      lint-version:
        required: false
        type: string
        default: "v2.6.0"
        description: golangci-lint version (e.g. v2.6.0). Uses go install for act/Go version compatibility.
      test-stable:
        required: false
        type: boolean
        default: false
        description: Also test against stable Go version (non-blocking, for compatibility check)


jobs:
  # Run test
  test:
    name: Test (${{ matrix.go-version }})
    timeout-minutes: 60
    runs-on: ${{ inputs.runs-on }}
    
    strategy:
      matrix:
        go-version: ${{ inputs.test-stable && fromJSON('["project", "stable"]') || fromJSON('["project"]') }}
      fail-fast: false
    
    # Stable version failures are non-blocking (for early compatibility detection)
    continue-on-error: ${{ matrix.go-version == 'stable' }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go (project version)
        uses: actions/setup-go@v6
        if: ${{ inputs.setup-go == true && matrix.go-version == 'project' }}
        with:
          go-version-file: ${{ inputs.gomod-path }}

      - name: Setup Go (stable)
        uses: actions/setup-go@v6
        if: ${{ inputs.setup-go == true && matrix.go-version == 'stable' }}
        with:
          go-version: 'stable'

      - name: Show Go version
        run: go version

      - name: "Unit Test"
        run: ${{ inputs.command-test }}

      - name: Archive code coverage results
        uses: actions/upload-artifact@v6
        if: success() && matrix.go-version == 'project'
        with:
          name: coverage-report
          path: coverage.out
          retention-days: 1

  # Run lint
  lint:
    name: Lint
    timeout-minutes: 30
    runs-on: ${{ inputs.runs-on }}
    if: github.event_name == 'pull_request' && inputs.lint
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup go
        uses: actions/setup-go@v6
        with:
          go-version-file: ${{ inputs.gomod-path }}
          cache: false

      # fix typecheck fails https://github.com/golangci/golangci-lint-action/issues/902
      - name: Download dependencies
        run: |
          go mod download

      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@${{ inputs.lint-version }}

      - name: Lint check
        run: golangci-lint run --timeout=${{ inputs.lint-timeout }} --config=${{ inputs.lint-path }}